#' @title lineFitFunction
#'
#' @param dataInput dataInput should be a data frame composed of two columns. One is for time other is for intensity. Or it should be a normalized data generated by normalizeData function
#' @param tryCounter is the input that represent the number of the call of this function for the same situation
#' @param startList  The initial set of parameters that algorithm tries for the fit, where the parameters are slope and intercetion.
#' @param lowerBounds The lower bouns for the randomly generated start parameters, where the parameters are slope and intercetion.
#' @param upperBounds The lower bouns for the randomly generated start parameters, where the parameters are slope and intercetion.
#' @param min_Factor define minimum step size in the iterations
#' @param n_iterations define maximum number of iterations for a run
#'
#' @return Function returns fitted parameters for lineFit. The slope, intersection and parameters related with quality of the fit
#' @export
#'
#' @examples
#' # related examples
#' intensity=c(0.9947917, 0.7395833, 0.4010417, 0.8020833, 0.5364583, 0.6718750, 0.6770833,
#'       0.6145833, 0.6041667, 0.2708333, 1.0000000, 0.4687500, 0.3385417, 0.5364583,
#'       0.4687500, 0.6041667, 0.6718750, 0.3333333, 0.4010417, 0.7500000, 0.2031250,
#'       0.4114583, 0.4010417, 0.8802083, 0.6041667, 0.7500000, 0.4010417, 0.8072917,
#'       0.4687500, 0.3333333, 0.2708333, 0.0000000, 0.4010417, 0.7343750, 0.4062500,
#'       0.6718750, 0.6666667, 0.3385417, 0.8020833, 0.5468750, 0.6093750, 0.6093750, 0.6770833)
#' time=seq(3,24,0.5)
#' dataInput=data.frame(intensity=intensity,time=time)
#' parameterVector<-lineFitFunction(dataInput,tryCounter=2)
#'
lineFitFunction<-function(dataInput,
                          tryCounter,
                          startList=list(slope=0,intersection=1),
                          lowerBounds=c(-100,-1000),
                          upperBounds=c(100,1000),
                          min_Factor=1/2^20,
                          n_iterations=500)
{

  isalist=(is.list(dataInput) & !is.data.frame(dataInput))
  if(isalist){dataFrameInput=dataInput$timeIntensityData; print("is a list")}
  isadataframe=(is.data.frame(dataInput))
  if(isadataframe){dataFrameInput=dataInput; print("is a data frame")}

  if(tryCounter==1){counterDependentStartList=startList}
  if(tryCounter!=1){
    randomVector=runif(length(startList), 0, 1)
    names(randomVector)<-c("slope","intersection")
    counterDependentStartVector=randomVector*(upperBounds-lowerBounds)+lowerBounds
    counterDependentStartList=as.list(counterDependentStartVector)}


  theFitResult <- minpack.lm::nlsLM(intensity ~ sicegar::lineFitFormula(time, slope, intersection),
                        dataFrameInput,
                        start=counterDependentStartList,
                        control = list(maxiter = n_iterations, minFactor = min_Factor),
                        lower = lowerBounds,
                        upper = upperBounds,
                        trace=F)

  parameterMatrix=summary(theFitResult)$parameters
  colnames(parameterMatrix)<-c("Estimate","Std_Error","t_value","Pr_t")


  parameterVector=c(t(parameterMatrix))
  names(parameterVector)<- c("slope_Estimate","slope_Std_Error","slope_t_value","slope_Pr_t",
                             "intersection_Estimate","intersection_Std_Error","intersection_t_value","intersection_Pr_t")

  parameterVector<-c(parameterVector,
                     residual_Sum_of_Squares=sum((as.vector(resid(theFitResult)))^2)[1],
                     log_likelihood=as.vector(logLik(theFitResult))[1],
                     AIC_value=as.vector(AIC(theFitResult))[1],
                     BIC_value=as.vector(BIC(theFitResult))[1])

  parameterList=as.list(parameterVector)
  parameterList$isThisaFit=TRUE
  parameterList$startVector=counterDependentStartList
  if(isalist){parameterList$dataScalingParameters=as.list(dataInput$dataScalingParameters)}
  parameterList$model="linaer"

  parameterDf=as.data.frame(parameterList)
  return(parameterDf)

}


# @title lineFitFormula
#
# @param x is the "time" (time) column of the dataframe
# @param slope is the slope of the line that we want to find in line fit
# @param intersection is the intensity intersection point of the line when time is zero in the time-intensity graph
#
# @return the function returns the predicted intensities for given time points in the line fit model
#
# @examples
#' @export
lineFitFormula<-function(x, slope, intersection){
  y=slope*x+intersection;
  return(y)}
