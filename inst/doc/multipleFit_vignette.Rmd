---
title: Multiple Fit Function
author: "Umut Caglar"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Multiple Fit Function}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
  
# Multiple Fit Function
This `sicegar:multipleFitFunction` aims to call the chosen fit algorithm multiple times by using randomly generated initiation vectors. The aim is to prevent gradient decent algorithm to stick in a local miimum.
  
  
```{r install packages, echo=FALSE, warning=FALSE, results='hide',message=FALSE}

###*****************************
# INITIAL COMMANDS TO RESET THE SYSTEM
rm(list = ls())
if (is.integer(dev.list())){dev.off()}
cat("\014")
seedNo=14159
set.seed(seedNo)
###*****************************

###*****************************
require("sicegar")
require("dplyr")
require("ggplot2")
###*****************************
```

## Data generation
To generate the additional parameters with the help of `sicegar:parameterCalculation` function we need fist need to make the fits for sigmoidal and double-sigmoidal data. In order to fit models to data we first need to generate the data with the help of `sicegar::sigmoidalFitFormula` and `sicegar::doublesigmoidalFitFormula`. To add some randomness to the input data I will use some noise. The input of all package must be in the form of a data frame with at least 2 columns time and intensity. 

We will generate data for all three models; linear sigmoidal and double sigmoidal 

### Generate data for linear
```{r generate data for linear}
time=seq(3,24,0.5)

#simulate intensity data with noise
noise_parameter=20
intensity_noise=stats::runif(n = length(time),min = 0,max = 1)*noise_parameter
intensity=sicegar::lineFitFormula(time, slope=4, intersection=-2)
intensity=intensity+intensity_noise

dataInputLinear=data.frame(intensity=intensity,time=time)
```

### Generate data for sigmoidal
```{r generate data for sigmoidal}
time=seq(3,24,0.5)

#simulate intensity data and add noise
noise_parameter=0.1
intensity_noise=stats::runif(n = length(time),min = 0,max = 1)*noise_parameter
intensity=sicegar::sigmoidalFitFormula(time, maximum=4, slope=1, midPoint=8)
intensity=intensity+intensity_noise

dataInputSigmoidal=data.frame(intensity=intensity,time=time)
```


### Generate data for double - sigmoidal
```{r generate data for double - sigmoidal}
noise_parameter=0.2
intensity_noise=runif(n = length(time),min = 0,max = 1)*noise_parameter
intensity=sicegar::doublesigmoidalFitFormula(time,
                                    finalAsymptoteIntensityRatio=.3,
                                    maximum=4,
                                    slope1=1,
                                    midPoint1Param=7,
                                    slope2=1,
                                    midPointDistanceParam=8)
intensity=intensity+intensity_noise

dataInputDoubleSigmoidal=data.frame(intensity=intensity,time=time)
```

## Data normalization 

This is the first step after generating data. Data should be normalized before any fit. I.e time and intensity should be in between 0-1 interval. 

The normalization code is 

```{r normalize_data}
normalizedLinearInput = sicegar::normalizeData(dataInput=dataInputLinear,
                                               dataInputName = "linearSample")

normalizedSigmoidalInput = sicegar::normalizeData(dataInput = dataInputSigmoidal, 
                                                  dataInputName = "sigmoidalSample")

normalizedDoubleSigmoidalInput = sicegar::normalizeData(dataInput = dataInputDoubleSigmoidal, 
                                                        dataInputName = "doubleSigmoidalSample")
```


## Fits for sigmoidal and double sigmoidal

We will now recalculate the parameters for linear sigmoidal and double sigmoidal datasets with the help of `sicegar::multipleFitFunction`. The aim is to prevent the algorithm to stuck in a local minimum. There are 3 important imputs of the function. Each attempt pf fit is labelled as `isThisaFit = TRUE / FALSE` with respect to the called fit function. If the fit function returns numerical values for parameters than it is a fit, if it can not and generates an error than it is NOT a fit.

* `model`: It defines the model that will be app;ied to the data.Can be linear, sigmoidal or doublesigmoidal
* `n_runs_min`: Needed number of successful fits The algorithm keeps calling the fit function untill it gets that many successfull fits. Default value is 20
* `n_runs_max`: If the called algorithm can not generate `n_runs_min` successful fits within `n_runs_max` fit attempts than it stops. Default value is 500

`n_runs_max` parameter should be greater than or equal to `n_runs_min` parameter.

```{r apply linear sigmoidal and doublesigmoidal fits many times}
# Do linear fit
linearModel<-sicegar::multipleFitFunction(dataInput=normalizedLinearInput,
                                 model="linear",
                                 n_runs_min=5,
                                 n_runs_max=15)

# Do the sigmoidal fit
sigmoidalModel=sicegar::multipleFitFunction(dataInput=normalizedSigmoidalInput,
                                   model="sigmoidal")


# Do the double sigmoidal fit
doubleSigmoidalModel=sicegar::multipleFitFunction(dataInput=normalizedDoubleSigmoidalInput,
                                         model="doublesigmoidal")
```

The algorithm generated 3 parameters in addition to the parameters of the fit function used

* `betterFit`: Number of times that the minimum AIC score gets a smaller value. I.e numer of times the multiple fit attempts increase performance
* `correctFit`: Number of successfull fits. If the fit algorithm returns successful fits `n_runs_min` times than `correctFit = n_runs_min`; or alternatively if the algorithm reach `n_runs_max` fit attepts before it reach `n_runs_min` successful fits then it is the number of successful fits obtained.
* `totalFit`: Total number of fits attempts 


## Model objects

Here are the parameter vectors that `sicegar::multipleFitFunction` generates

```{r parameter vectors}
print(t(linearModel))
print(t(sigmoidalModel))
print(t(doubleSigmoidalModel))
```
