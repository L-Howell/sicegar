---
title: The categorize function
author: "Umut Caglar"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The categorize function}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
  
# The categorize function
This is a document provide examples related with categorize function. It will investigate 2 examples one is related with sigmoidal and other is related with double sigmoidal
  
  
```{r install packages, echo=FALSE, warning=FALSE, results='hide',message=FALSE}

###*****************************
# INITIAL COMMANDS TO RESET THE SYSTEM
rm(list = ls())
if (is.integer(dev.list())){dev.off()}
cat("\014")
seedNo=14159
set.seed(seedNo)
###*****************************

###*****************************
require("sicegar")
require("dplyr")
require("ggplot2")
require("cowplot")
###*****************************
```

## Data generation
To generate the figures, we will go backwards and firstly generate some data to analize. To add some randomness to the input data I will use some noise. The input of all package must be in the form of a data frame with at least 2 columns time and intensity. 

We will generate data for both sigmoidal and double sigmoidal 

### Generate data for sigmoidal
```{r generate data for sigmoidal}
time=seq(3,24,0.5)

#simulate intensity data and add noise
noise_parameter=0.1
intensity_noise=stats::runif(n = length(time),min = 0,max = 1)*noise_parameter
intensity=sicegar::sigmoidalFitFormula(time, maximum=4, slopeParam=1, midPoint=8)
intensity=intensity+intensity_noise

dataInputSigmoidal=data.frame(intensity=intensity,time=time)
```


### Generate data for double - sigmoidal
```{r generate data for double - sigmoidal}
noise_parameter=0.2
intensity_noise=runif(n = length(time),min = 0,max = 1)*noise_parameter
intensity = sicegar::doublesigmoidalFitFormula(time,
                                    finalAsymptoteIntensityRatio=.3,
                                    maximum=4,
                                    slope1Param=1,
                                    midPoint1Param=7,
                                    slope2Param=1,
                                    midPointDistanceParam=8)
intensity=intensity+intensity_noise
dataInputDoubleSigmoidal=data.frame(intensity=intensity,time=time)
```

## Data normalization 

This is the first step. Data should be normalized before any fit. I.e time and intensity should be in between 0-1 interval. 

The normalization code is 

```{r normalize_data}
normalizedSigmoidalInput = sicegar::normalizeData(dataInput = dataInputSigmoidal, 
                                         dataInputName = "sigmoidalSample")

normalizedDoubleSigmoidalInput = sicegar::normalizeData(dataInput = dataInputDoubleSigmoidal, 
                                         dataInputName = "doubleSigmoidalSample")
```

## Pre Categorize
Checks if signal is present in the data. Often a high percentage of high through-put data does not contain a signal. Checking if data does not contain signal before doing a sigmoidal or double sigmoidal fit can make analysis of data from high through-put experiments much faster.

```{r pre categorize data}
preDecision_sd = sicegar::pre_categorize(normalizedInput = normalizedSigmoidalInput)
preDecision_dsd = sicegar::pre_categorize(normalizedInput = normalizedDoubleSigmoidalInput)
```


## Fits for sigmoidal and double sigmoidal

Now we need to fit all three models to the data. Linear, sigmoidal and double sigmoidal on both sigmoidal and double-sigmoidal data.


### Fit Linear, Sigmoidal and Double-Sigmoidal models to Sigmoidal data

```{r linear sigmoidal and double-sigmoidal fits to sigmoidal data}
# Do the sigmoidal fit
# Fit linear model
linearModel_sd=sicegar::multipleFitFunction(dataInput=normalizedSigmoidalInput,
                                            model="linear",
                                            n_runs_min=20,
                                            n_runs_max=500,
                                            showDetails=FALSE)

# Fit sigmoidal model
sigmoidalModel_sd=sicegar::multipleFitFunction(dataInput=normalizedSigmoidalInput,
                                               model="sigmoidal",
                                               n_runs_min=20,
                                               n_runs_max=500,
                                               showDetails=FALSE)

# Fit double sigmoidal model
doubleSigmoidalModel_sd=sicegar::multipleFitFunction(dataInput=normalizedSigmoidalInput,
                                                     model="doublesigmoidal",
                                                     n_runs_min=20,
                                                     n_runs_max=500,
                                                     showDetails=FALSE)
```


### Fit Linear, Sigmoidal and Double-Sigmoidal models to Double-Sigmoidal data

```{r linear sigmoidal amd double-sigmoidal fits to double-sigmoidal data}
# Do the sigmoidal fit
# Fit linear model
linearModel_dsd=sicegar::multipleFitFunction(dataInput=normalizedDoubleSigmoidalInput,
                                             model="linear",
                                             n_runs_min=20,
                                             n_runs_max=500,
                                             showDetails=FALSE)

# Fit sigmoidal model
sigmoidalModel_dsd=sicegar::multipleFitFunction(dataInput=normalizedDoubleSigmoidalInput,
                                                model="sigmoidal",
                                                n_runs_min=20,
                                                n_runs_max=500,
                                                showDetails=FALSE)

# Fit double sigmoidal model
doubleSigmoidalModel_dsd=sicegar::multipleFitFunction(dataInput=normalizedDoubleSigmoidalInput,
                                                      model="doublesigmoidal",
                                                      n_runs_min=20,
                                                      n_runs_max=500,
                                                      showDetails=FALSE)
```


Now we will apply `sicegar::parameterCalculation` function to all sigmoidal and double sigmoidal models in order to generate additional variables.

```{r generate additional parameters for sigmoidalModel and doubleSigmoidalModel}
# Generate additional parameters for sigmoidal Data. For both sigmoidal model with sigmoidal data distribution and double sigmoidal model with sigmoidal data distribution
sigmoidalModel_sd = sicegar::parameterCalculation(sigmoidalModel_sd)
doubleSigmoidalModel_sd = sicegar::parameterCalculation(doubleSigmoidalModel_sd)


# Generate additional parameters for double sigmoidal Data. For both sigmoidal model with double sigmoidal data distribution and double sigmoidal model with double sigmoidal data distribution
sigmoidalModel_dsd = sicegar::parameterCalculation(sigmoidalModel_dsd)
doubleSigmoidalModel_dsd = sicegar::parameterCalculation(doubleSigmoidalModel_dsd)
```


## Generate figures

Here are the two datasets that we want to categorize
```{r cowplor figure, echo=TRUE, message=FALSE, warning=FALSE, comment=FALSE, fig.height=4, fig.width=8}
fig03a=sicegar::figureModelCurves(dataInput=normalizedSigmoidalInput,
                                  sigmoidalFitVector=sigmoidalModel_sd,
                                  showParameterRelatedLines=TRUE)
#print(fig03a)

# Double Sigmoidal Fit with parameter related lines
fig03b=sicegar::figureModelCurves(dataInput=normalizedDoubleSigmoidalInput,
                                  doubleSigmoidalFitVector=doubleSigmoidalModel_dsd,
                                  showParameterRelatedLines=TRUE)
#print(fig03b)

fig03 <- cowplot::plot_grid(fig03a, fig03b, ncol = 2)
print(fig03)
```

## Model decision

Now we have attempts of fits for linear, sigmoidal and double sigmoidal models on our datasets. By using the results of those atempts one can make decisions about the category of the input data; wheather it is sigmoidal or double sigmoidal.

```{r decide wheather the data is sigmoidal or double sigmoidal}
outputCluster_sd=sicegar::categorize(parameterVectorSigmoidal=sigmoidalModel_sd,
                                     parameterVectorDoubleSigmoidal=doubleSigmoidalModel_sd)

utils::str(outputCluster_sd) # This should give sigmoidal

outputCluster_dsd=sicegar::categorize(parameterVectorSigmoidal=sigmoidalModel_dsd,
                                      parameterVectorDoubleSigmoidal=doubleSigmoidalModel_dsd)

utils::str(outputCluster_dsd) # This should give double-sigmoidal
```


## The Decision Process

The decision process composes mainly two parts parts. The first one is pre-test process that controls if everything provided is useful and fits to each_other. If one calls the main function and the main function calls the `sicegar::categorize()` then the precheck steps do not matter. The steps of pretest are;

* Pre-test0: If it was provided sigmoidal and double_sigmoidal models
* Pre-test1: If the provided sigmoidal and double sigmoidal models come from same source and have the same data name
* Pre-test2a: Does the provided sigmoidal model is really generated by `sicegar::sigmoidalFitFunctions`
* Pre-test2b: Does the provided double_sigmoidal model is really generateed by `sicegar::doublesigmoidalFitFunctions`
* Pre-test3: Do both models have same data normalization related scaling parameters
* Pre-test4a: Do the additional parameters for sigmoidal fit calculated by `sicegar::parameterCalculation()`
* Pre-test4b: Do the additional parameters for double-sigmoidal fit calculated by `sicegar::parameterCalculation()` 

Then the decision process starts with generating the choices vector
`choices = c("no_signal", "sigmoidal", "double_sigmoidal", "ambiguous")`

The following procedure deletes the not possible choices from the vector untill only one choice left.

Firstly algorithm checks if the provided data includes a signal or not

* Test 1a: Observed intensity maximum must be bigger than `threshold_minimum_for_intensity_maximum`, otherwise the data is labelled with "no_signal"
* Test 1b: 1b. `intensity_max`, `intensity_min` difference, i.e intensity range must be greater than `threshold_intensity_range`, otherwise the data is labelled with "no_signal"
* Test 1c: If at this point the data is not labelled with `"no_signal"`; than the data can not labelled with `"no signal"`.

Then the algorithm checks if the sigmoidal and double sigmoidal models make sense.

* Test 2a: Provided sigmoidal fit must be a successful fit, otherwise the data can not labelled with `"sigmoidal"`.
* Test 2b: Provided double sigmoidal fit must be a successful fit, otherwise the data can not labelled with `"double_sigmoidal"`.
* Test 3a: Sigmoidal fit must have an AIC score smaller than `threshold_AIC`, otherwise the data can not labelled with `"sigmoidal"`.
* Test 3b: Double sigmoidal fit must have an AIC score smaller than `threshold_AIC`, otherwise the data can not labelled with `"double_sigmoidal"`.
* Test 4a: Sigmoidal models `startPoint_x` must be a positive number, otherwise the data can not labelled with `"sigmoidal"`.
* Test 4b: Double-sigmoidal models `startPoint_x` must be a positive number, otherwise the data can not labelled with `"double_sigmoidal"`.
* Test 5a: Sigmoidal models `start_intensity`, i.e. the intensity at t=0, must be smaller than `threshold_t0_max_int`, otherwise the data can not labelled with `"sigmoidal"`.
* Test 5b: Double sigmoidal models `start_intensity`, i.e. the intensity at t=0, must be smaller than `threshold_t0_max_int`, otherwise the data can not labelled with `"double_sigmoidal"`.
* Test 6: For the double sigmoidal model; the ratio of _/models intensity prediction at last observation time/_ to _/the models maximum intesity prediction/_ must be smaller than `threshold_dsm_tmax_IntensityRatio`, otherwise the data can not labelled with `"double_sigmoidal"`.
* Test7: For the sigmoidal model; the ratio of _/models intensity prediction at last observation time/_ to _/the models maximum intesity prediction/_ must be smaller than `threshold_sm_tmax_IntensityRatio`, otherwise the data can not labelled with `"sigmoidal"`.

In the third part, the algorithm checks wheather the data should be labelled as `"ambiguous"` or not.

* Test 8: If at this point we still have at least one of `"sigmoidal"` or `"double_sigmoidal"` options, than the data can not labelled with `"ambiguous"`

In he last part, the algorithm checks wheather the data should be labelled as `"sigmoidal"` or `"double_sigmoidal"`.

* Test 9: Now if at this point we still have both "sigmoidal" and "double_sigmoidal" options, then the choice will be made based on AIC scores of those models and `threshold_bonus_sigmoidal_AIC`. Smaller side of the equation is the decision;
    * if `sigmoidalAIC + threshold_bonus_sigmoidal_AIC  <  doublesigmoidalAIC`, than the data can not labelled with `"double_sigmoidal"`
    * if `sigmoidalAIC + threshold_bonus_sigmoidal_AIC  >  doublesigmoidalAIC`, than the data can not labelled with `"sigmoidal"`

Te only option that is left on this point is the label of the data.



