---
title: Fitting individual models
author: "Umut Caglar, Claus O. Wilke"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fitting individual models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Sometimes it can be useful to fit only specific models to a dataset rather than fit multiple models and run the decision algorithm. For this purpose, **sicegar** provides the function `multipleFitFunction()`. This function fits a chosen model to the input dataset. It calls the fitting algorithm multiple times with different, randomly generated start parameters, to guarantee robust and reliable fitting.  


```{r install packages, echo=FALSE, warning=FALSE, results='hide',message=FALSE}

###*****************************
seedNo=14159
set.seed(seedNo)
###*****************************

###*****************************
require("sicegar")
require("dplyr")
require("ggplot2")
###*****************************
```

We will demonstrate the use of this function on double-sigmoidal data, generated by adding some noise to the double-sigmoidal curve used for fitting, implemented in `doublesigmoidalFitFormula()`.


```{r generate data for double - sigmoidal}
time <- seq(3, 24, 0.5)
noise_parameter <- 0.2
intensity_noise <- runif(n = length(time), min = 0, max = 1) * noise_parameter
intensity <- doublesigmoidalFitFormula(time,
                                       finalAsymptoteIntensityRatio = .3,
                                       maximum = 4,
                                       slope1Param = 1,
                                       midPoint1Param = 7,
                                       slope2Param = 1,
                                       midPointDistanceParam = 8)
intensity <- intensity + intensity_noise
dataInputDoubleSigmoidal <- data.frame(intensity, time)
```

Before we can perform the fit, we need to normalize the data appropriately. This is done by the function `normalizeData()`:
```{r normalize_data}
normalizedDoubleSigmoidalInput = sicegar::normalizeData(dataInput = dataInputDoubleSigmoidal, 
                                                        dataInputName = "doubleSigmoidalSample")
```


## Fits for sigmoidal and double sigmoidal

We will now recalculate the parameters for linear sigmoidal and double sigmoidal datasets with the help of `sicegar::multipleFitFunction`. The aim is to prevent the algorithm to stuck in a local minimum. There are 3 important imputs of the function. Each attempt pf fit is labelled as `isThisaFit = TRUE / FALSE` with respect to the called fit function. If the fit function returns numerical values for parameters than it is a fit, if it can not and generates an error than it is NOT a fit.

* `model`: It defines the model that will be app;ied to the data.Can be linear, sigmoidal or doublesigmoidal
* `n_runs_min`: Needed number of successful fits The algorithm keeps calling the fit function untill it gets that many successfull fits. Default value is 20
* `n_runs_max`: If the called algorithm can not generate `n_runs_min` successful fits within `n_runs_max` fit attempts than it stops. Default value is 500

`n_runs_max` parameter should be greater than or equal to `n_runs_min` parameter.

```{r}
# Do linear fit
linearModel <- sicegar::multipleFitFunction(dataInput=normalizedDoubleSigmoidalInput,
                                 model="linear",
                                 n_runs_min=5,
                                 n_runs_max=15)

# Do the sigmoidal fit
sigmoidalModel <- sicegar::multipleFitFunction(dataInput=normalizedDoubleSigmoidalInput,
                                   model="sigmoidal")


# Do the double sigmoidal fit
doubleSigmoidalModel <- sicegar::multipleFitFunction(dataInput=normalizedDoubleSigmoidalInput,
                                         model="doublesigmoidal")
```

The algorithm generated 3 parameters in addition to the parameters of the fit function used

* `betterFit`: Number of times that the minimum AIC score gets a smaller value. I.e numer of times the multiple fit attempts increase performance
* `correctFit`: Number of successfull fits. If the fit algorithm returns successful fits `n_runs_min` times than `correctFit = n_runs_min`; or alternatively if the algorithm reach `n_runs_max` fit attepts before it reach `n_runs_min` successful fits then it is the number of successful fits obtained.
* `totalFit`: Total number of fits attempts 


## Model objects

Here are the parameter vectors that `sicegar::multipleFitFunction` generates

```{r parameter vectors}
t(linearModel)
t(sigmoidalModel)
t(doubleSigmoidalModel)
```
