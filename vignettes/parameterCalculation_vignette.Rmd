---
title: Parameter Calculation Function
author: "Umut Caglar"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Parameter Calculation Function}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
  
# Parameter Calculation Function
This `sicegar:parameterCalculation` function aims to generate additional parameters from the parameters generated by sigmoidal and double sigmoidal fit functions. Those new paramters are helpful to quantify the time intensity curves.
  
  
```{r install packages, echo=FALSE, warning=FALSE, results='hide',message=FALSE}

###*****************************
# INITIAL COMMANDS TO RESET THE SYSTEM
rm(list = ls())
if (is.integer(dev.list())){dev.off()}
cat("\014")
seedNo=14159
set.seed(seedNo)
###*****************************

###*****************************
require("sicegar")
require("dplyr")
require("ggplot2")
###*****************************
```

## Data generation
To generate the additional parameters with the help of `sicegar:parameterCalculation` function we need fist need to make the fits for sigmoidal and double-sigmoidal data. In order to fit models to data we first need to generate the data with the help of `sicegar::sigmoidalFitFormula` and `sicegar::doublesigmoidalFitFormula`. To add some randomness to the input data I will use some noise. The input of all package must be in the form of a data frame with at least 2 columns time and intensity. 

We will generate data for both sigmoidal and double sigmoidal 

### Generate data for sigmoidal
```{r generate data for sigmoidal}
time=seq(3,24,0.5)

#simulate intensity data and add noise
noise_parameter=0.1
intensity_noise=stats::runif(n = length(time),min = 0,max = 1)*noise_parameter
intensity=sicegar::sigmoidalFitFormula(time, maximum=4, slope=1, midPoint=8)
intensity=intensity+intensity_noise

dataInputSigmoidal=data.frame(intensity=intensity,time=time)
```


### Generate data for double - sigmoidal
```{r generate data for double - sigmoidal}
noise_parameter=0.2
intensity_noise=runif(n = length(time),min = 0,max = 1)*noise_parameter
intensity=sicegar::doublesigmoidalFitFormula(time,
                                    finalAsymptoteIntensityRatio=.3,
                                    maximum=4,
                                    slope1=1,
                                    midPoint1Param=7,
                                    slope2=1,
                                    midPointDistanceParam=8)
intensity=intensity+intensity_noise

dataInputDoubleSigmoidal=data.frame(intensity=intensity,time=time)
```

## Data normalization 

This is the first step after generating data. Data should be normalized before any fit. I.e time and intensity should be in between 0-1 interval. 

The normalization code is 

```{r normalize_data}
normalizedSigmoidalInput = sicegar::normalizeData(dataInput = dataInputSigmoidal, 
                                         dataInputName = "sigmoidalSample")

normalizedDoubleSigmoidalInput = sicegar::normalizeData(dataInput = dataInputDoubleSigmoidal, 
                                         dataInputName = "doubleSigmoidalSample")
```


## Fits for sigmoidal and double sigmoidal

We will now recalculate the parameters for sigmoidal and double sigmoidal datasets

```{r sigmoidal and double sigmoidal fit to datasets}
# Do the sigmoidal fit
sigmoidalModel=sicegar::multipleFitFunction(dataInput=normalizedSigmoidalInput,
                                   model="sigmoidal")


# Do the double sigmoidal fit
doubleSigmoidalModel=sicegar::multipleFitFunction(dataInput=normalizedDoubleSigmoidalInput,
                                         model="doublesigmoidal")
```


Now we will apply `sicegar::parameterCalculation` function to generate additional variables.

```{r generate additional parameters for sigmoidalModel and doubleSigmoidalModel}
# Generate additional parameters for sigmoidalModel 
sigmoidalModel = sicegar::parameterCalculation(sigmoidalModel)


# Generate additional parameters for doubleSigmoidalModel
doubleSigmoidalModel = sicegar::parameterCalculation(doubleSigmoidalModel)
```


here are the parameters, that the models have after calculating additional parameters.

## Sigmoidal model additional parameters
```{r generate additional parameters for sigmoidalModel}
# Parameters for sigmoidalModel 
print(t(sigmoidalModel))
```


For the sigmoidalModel; firstly the `additionalParameters` switched from FALSE to TRUE

And the parameters explained below are calculated

Maximum of the fitted model

* `maximum_x`: Shows the time that the fit line reach the maximum value. Because of the nature of the sigmoidal function this value is always equal to "inf", so the output is always "NA"
* `maximum_y`: The maximum intensity the fitted function reach at time = "inf". [The value is equal to `maximum_Estimate`]

Midpoint of the fitted model. Basically the point where the slope is maximum and when the intensity is half of maximum intensity

* `midPoint_x`: The time that the fitted function reach the midpoint. [The value is equal to `midPoint_Estimate`]
* `midPoint_y`: The intensity of the midpoint. [The value is equal to `maximum_y / 2`]

The slope of the fitted model. 

* `slope`: The maximum slope that the fitted model have. This is the slope at the midpoint. [The value is equal to `slopeParam_Estimate * maximum_y * (1/4)`]

The following parameters are relavent with the `slope line`; which is the line that passes from `midPoint` and tangential to the fitted model.

* `incrementTime`: This is the time inerval in between the intersection of `slope line` and `y = 0` and `y = maximum_y`. [This value is equal to `maximum_y / slope`]

The start point is defined as the point where the `slope line` intersects with `y = 0`

* `startPoint_x`: the time of start point. Roughly, represents the moment that the intensity signal first appears. [This value is equal to `midPoint_x - (incrementTime/2)`]
* `startPoint_y`: the intensity of start point. Equals to `0` by defination

The reach maximum point is defined as the point where the `slope line` intersects with `y = maximum_y`

* `reachMaximum_x`: the time of reach maximum point. Roughly, represents the moment that the intensity signal reaches maximum. [This value is equal to `midPoint_x + (incrementTime/2)`]
* `reachMaximum_y`: the intensity of reach maximum point. Equals to `maximum_y` by defination


## Double-sigmoidal model additional parameters
```{r generate additional parameters for doubleSigmoidalModel}
# Parameters for double sigmoidal model
print(t(doubleSigmoidalModel))
```


For the double-sigmoidalModel; firstly the `additionalParameters` switched from FALSE to TRUE

And the parameters explained below are calculated

Maximum of the fitted model

* `maximum_x`: Shows the time that the fit line reach the maximum value. Because of the nature of the sigmoidal function this value is always equal to "inf", so the output is always "NA"
* `maximum_y`: The maximum intensity the fitted function reach at time = "inf". [The value is equal to `maximum_Estimate`]

finalAsymptoteIntensity of the fitted model

* `finalAsymptoteIntensity`: is the value that the fitted function reaches asymptotically at `time = inf`. [This value is equal to `finalAsymptoteIntensityRatio_Estimate * maximum_y`]


midPoint1 and midPoint2 of the fitted model are the points where the intensity for the first time reaches half of maximum intensity, and the intensity decreases half way from maximum intensity to final asymptote intensity.

* `midPoint1_x`: The time that the fitted function reach the midpoint1. [The value is calculated numerically and is different from `midPoint1Param_Estimate`]
* `midPoint1_y`: The intensity of the midpoint1. [The value is calculated numerically and is equal to `maximum_y / 2`]
* `midPoint2_x`: The time that the fitted function reach the midpoint2. [The value is calculated numerically and is different from `midPoint2Param_Estimate`]
* `midPoint2_y`: The intensity of the midpoint2. [The value is calculated numerically and is equal to `finalAsymptoteIntensity + (maximum_y - finalAsymptoteIntensity)/2`]

The slopes of the fitted model. 

* `slope1`: The slope of the fitted model at `midPoint1` [The value is calculated numerically and is different from `slope1Param_Estimate`]
* `slope2`: The slope of the fitted model at `midPoint2` [The value is calculated numerically and is different from `slope2Param_Estimate`]

The following parameters are relavent with the `slope line 1`; which is the line that passes from `midPoint1` and tangential to the fitted model.

* `incrementTime`: This is the time inerval in between the intersection of `slope line 1` and `y = 0` and `y = maximum_y`. [This value is equal to `maximum_y / slope1`]

The start point is defined as the point where the `slope line 1` intersects with `y = 0`

* `startPoint_x`: the time of start point. Roughly, represents the moment that the intensity signal first appears. [This value is equal to `midPoint1_x - (incrementTime/2)`]
* `startPoint_y`: the intensity of start point. Equals to `0` by defination

The reach maximum point is defined as the point where the `slope line 1` intersects with `y = maximum_y`

* `reachMaximum_x`: the time of reach maximum point. Roughly, represents the moment that the intensity signal reaches maximum. [This value is equal to `midPoint1_x + (incrementTime/2)`]
* `reachMaximum_y`: the intensity of reach maximum point. Equals to `maximum_y` by defination


The following parameters are relavent with the `slope line 12`; which is the line that passes from `midPoint2` and tangential to the fitted model.

* `decrementTime`: This is the time inerval in between the intersection of `slope line 2` and `y = maximum_y` and `y = finalAsymptoteIntensity`. [This value is equal to `- (maximum_y -finalAsymptoteIntensity)/ slope2`]

The start point is defined as the point where the `slope line 1` intersects with `y = 0`

* `startDeclinePoint_x`: the time of start decline point. Roughly, represents the moment that the intensity signal starts to drop from maximum value. [This value is equal to `midPoint2_x - (decrementTime/2)`]
* `startDeclinePoint_y`: the intensity of start decline point. Equals to `maximum_y` by defination

The reach maximum point is defined as the point where the `slope line 1` intersects with `y = maximum_y`

* `endDeclinePoint_x`: the time of end decline point. Roughly, represents the moment that the intensity signal reaches final asymptote intensity. [This value is equal to `midPoint2_x + (decrementTime/2)`]
* `endDeclinePoint_y`: the intensity of end decline point. Equals to `finalAsymptoteIntensity` by defination
